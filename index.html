<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultivanPi Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: rgba(25, 25, 25, 0.9);
            --accent-color: #00d4ff;
            --text-color: #ffffff;
            --success-color: #44ff44;
            --warning-color: #ffcc00;
            --font-header: 4rem;      
            --font-clock: 4rem;       
            --font-date: 2rem;        
        }

        /* HARDWARE ROTATION FIX (2K Display 2560x1440) */
        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Inter', sans-serif; overflow: hidden;
            width: 2560px; height: 1440px; transform: rotate(90deg); transform-origin: top left;
            position: absolute; top: 0; left: 1440px; display: flex; flex-direction: column;
        }

        .header {
            padding: 60px 100px;
            display: flex;
            justify-content: space-between;
            align-items: center; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h2 { font-size: var(--font-header); margin: 0; letter-spacing: 2px; font-weight: 700; }
        .time-container { text-align: right; }
        #clock { font-size: var(--font-clock); font-weight: 300; line-height: 1; }
        #date { font-size: var(--font-date); opacity: 0.4; text-transform: uppercase; margin-top: 8px; }

        .view-container { flex-grow: 1; position: relative; padding: 60px 100px; }
        .view { display: none; width: 100%; height: 100%; animation: fadeIn 0.4s ease-out; }
        .view.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 50px; height: 100%; }

        .card {
            background: var(--card-bg); border-radius: 50px; padding: 60px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.2s ease; cursor: pointer; text-align: center;
        }

        .xtramp-box {
            border: 4px solid var(--accent-color);
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.2);
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.05), rgba(0, 0, 0, 0));
        }

        .card-label { font-size: 2.2rem; opacity: 0.5; text-transform: uppercase; letter-spacing: 4px; margin-bottom: 15px; }
        .unit { font-size: 3rem; opacity: 0.3; margin-left: 10px; }

        .subview-grid { 
            display: grid; 
            grid-template-columns: 1.5fr 1fr 1fr; 
            grid-template-rows: repeat(2, 1fr); 
            gap: 40px; 
            height: 100%; 
        }

        .detail-card { 
            background: rgba(20, 20, 20, 0.8); border-radius: 40px; padding: 50px; 
            border: 1px solid rgba(255, 255, 255, 0.05); display: flex; flex-direction: column; justify-content: space-between;
        }

        /* BOTTOM BUTTON (Home) */
        .home-btn {
            position: fixed; bottom: 80px; right: 80px; 
            width: 240px; height: 240px; 
            background: var(--card-bg); border: 5px solid var(--accent-color); border-radius: 60px;
            display: none; justify-content: center; align-items: center; cursor: pointer; z-index: 1000;
        }
        
        /* Icon skalierung auf 192px (80% von 240px) */
        /* Wir erzwingen die Größe für das SVG direkt */
        .home-btn svg { width: 192px !important; height: 192px !important; stroke-width: 1.2; color: #ffffff !important; }

        .status-bar {
            padding: 15px 100px; font-size: 1.5rem; opacity: 0.4; display: flex; justify-content: space-between;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card svg.large-icon { width: 180px !important; height: 180px !important; margin-bottom: 30px; }
        .detail-card svg.mid-icon { width: 70px !important; height: 70px !important; margin-bottom: 15px; opacity: 0.7; }

        .status-dot {
            width: 20px; height: 20px; background: var(--success-color); border-radius: 50%;
            display: inline-block; margin-right: 20px;
        }

        .small-label { font-size: 1.8rem; opacity: 0.4; text-transform: uppercase; margin-bottom: 5px; }
        .val-mid { font-size: 5.5rem; font-weight: 700; line-height: 1.2; }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div>
            <h2>MULTIVAN<span style="color: var(--accent-color); font-weight: 900;">PI</span></h2>
            <p><span id="sys-status-dot" class="status-dot"></span> <span id="sys-status-text">Warte auf Server...</span></p>
        </div>
        <div class="time-container">
            <div id="clock">00:00</div>
            <div id="date">--</div>
        </div>
    </div>

    <!-- Main View Area -->
    <div class="view-container">
        <!-- HOME VIEW -->
        <section id="view-home" class="view active">
            <div class="grid">
                <div class="card xtramp-box" onclick="showView('victron')">
                    <i data-lucide="zap" class="large-icon" color="#00d4ff"></i>
                    <div>
                        <div class="card-label">Energie</div>
                        <div id="home-soc" style="font-size: 6.5rem; font-weight: 800;">--<span class="unit">%</span></div>
                    </div>
                </div>
                <div class="card" onclick="showView('victron')">
                    <i data-lucide="thermometer" class="large-icon"></i>
                    <div>
                        <div class="card-label">Klima</div>
                        <div id="home-temp" style="font-size: 8rem; font-weight: 800;">--<span class="unit">°C</span></div>
                    </div>
                </div>
                <div class="card">
                    <i data-lucide="droplets" class="large-icon"></i>
                    <div>
                        <div class="card-label">Wasser</div>
                        <div style="font-size: 8rem; font-weight: 800;">75<span class="unit">%</span></div>
                    </div>
                </div>
                <div class="card" onclick="location.reload()">
                    <i data-lucide="refresh-cw" class="large-icon" style="opacity: 0.3;"></i>
                    <div>
                        <div class="card-label">System</div>
                        <div style="font-size: 3rem; font-weight: 800; color: var(--accent-color);">REFRESH</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VICTRON VIEW -->
        <section id="view-victron" class="view">
            <div class="subview-grid">
                <div class="detail-card xtramp-box" style="grid-row: span 2;">
                    <div>
                        <div class="card-label">SmartShunt Aufbau</div>
                        <div id="vic-soc" style="font-size: 14rem; font-weight: 900; color: var(--accent-color);">--<span class="unit" style="font-size: 6rem;">%</span></div>
                    </div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="small-label">Spannung</div>
                            <div id="vic-volt-aufbau" class="val-mid">--<span class="unit">V</span></div>
                        </div>
                        <div>
                            <div class="small-label">Strom</div>
                            <div id="vic-amp-aufbau" class="val-mid">--<span class="unit">A</span></div>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div><i data-lucide="sun" class="mid-icon" color="#ffcc00"></i><div class="card-label">Solar</div></div>
                    <div id="vic-solar" class="val-mid">--<span class="unit">W</span></div>
                </div>

                <div class="detail-card">
                    <div><i data-lucide="battery" class="mid-icon"></i><div class="card-label">Starter</div></div>
                    <div id="vic-starter" class="val-mid">--<span class="unit">V</span></div>
                </div>

                <div class="detail-card">
                    <div><i data-lucide="thermometer-snowflake" class="mid-icon"></i><div class="card-label">SmartSense</div></div>
                    <div id="vic-sense" class="val-mid">--<span class="unit">°C</span></div>
                    <div id="vic-sense-status" class="small-label">Warte auf BLE...</div>
                </div>

                <div class="detail-card">
                    <div><i data-lucide="truck" class="mid-icon"></i><div class="card-label">Booster</div></div>
                    <div id="vic-booster" class="val-mid">--<span class="unit">A</span></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Status Bar (Diagnosefelder) -->
    <div class="status-bar">
        <div id="sys-id">Server-ID: Suche...</div>
        <div id="sys-pkts">Empfangene Pakete: 0</div>
    </div>

    <!-- Home Button -->
    <div id="btn-home" class="home-btn" onclick="showView('home')">
        <i data-lucide="home"></i>
    </div>

    <script>
        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            document.getElementById('btn-home').style.display = (id === 'home') ? 'none' : 'flex';
        }

        async function fetchData() {
            try {
                // Lokaler Abruf am Pi
                const res = await fetch("http://127.0.0.1:3000/api/data?t=" + Date.now());
                if (!res.ok) throw new Error();
                const data = await res.json();

                // Status Felder aktualisieren
                document.getElementById('sys-id').innerText = "Server-ID: " + (data.session || "Verbunden");
                document.getElementById('sys-pkts').innerText = "Empfangene Pakete: " + (data.sense_packets || 0);

                // Victron Data mapping
                if (data.aufbau_soc !== undefined) {
                    const socVal = data.aufbau_soc.toFixed(1);
                    document.getElementById('home-soc').innerHTML = socVal + '<span class="unit">%</span>';
                    document.getElementById('vic-soc').innerHTML = socVal + '<span class="unit" style="font-size: 6rem;">%</span>';
                }
                
                if (data.aufbau_volt !== undefined) document.getElementById('vic-volt-aufbau').innerText = data.aufbau_volt.toFixed(2) + "V";
                if (data.aufbau_amp !== undefined) document.getElementById('vic-amp-aufbau').innerText = data.aufbau_amp.toFixed(1) + "A";
                
                if (data.sense_temp !== undefined) {
                    const t = parseFloat(data.sense_temp);
                    document.getElementById('home-temp').innerHTML = t.toFixed(1) + '<span class="unit">°C</span>';
                    document.getElementById('vic-sense').innerHTML = t.toFixed(1) + '<span class="unit">°C</span>';
                    document.getElementById('vic-sense-status').innerText = "Status: " + (data.sense_packets > 0 ? "LIVE (" + data.sense_last + ")" : "Warte auf BLE...");
                }
                
                if (data.solar_watt !== undefined) document.getElementById('vic-solar').innerText = data.solar_watt + "W";
                if (data.starter_volt !== undefined) document.getElementById('vic-starter').innerText = data.starter_volt.toFixed(2) + "V";
                if (data.booster_amp !== undefined) document.getElementById('vic-booster').innerText = data.booster_amp.toFixed(1) + "A";

                document.getElementById('sys-status-dot').style.backgroundColor = "var(--success-color)";
                document.getElementById('sys-status-text').innerText = "SYSTEM ONLINE";
            } catch (e) {
                document.getElementById('sys-status-dot').style.backgroundColor = "red";
                document.getElementById('sys-status-text').innerText = "VERBINDUNGSFEHLER";
                document.getElementById('sys-pkts').innerText = "Pakete: Fehler beim Abruf";
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('date').textContent = now.toLocaleDateString('de-DE', {weekday: 'long', day: 'numeric', month: 'long'});
        }

        setInterval(updateClock, 1000);
        setInterval(fetchData, 2000);
        updateClock(); fetchData(); lucide.createIcons();
    </script>
</body>
</html>
