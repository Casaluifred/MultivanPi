<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultivanPi Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script src="/static/lucide.min.js"></script>
    <script>if (!window.lucide) document.write('<script src="https://unpkg.com/lucide@latest"><\/script>');</script>
    <script src="/static/chart.min.js"></script>
    <script>if (!window.Chart) document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>');</script>

    <script>
        // --- VERSION ---
        const FRONT_VERSION = "3.2";
    </script>

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: rgba(25, 25, 25, 0.95);
            --accent-color: #00d4ff;
            --text-color: #ffffff;
            --success-color: #44ff44;
            --warning-color: #ffcc00;
            --danger-color: #ff4444;
            --usb-color: #ff9900;
            --level-liquid: rgba(202, 255, 66, 0.15); 
            --level-border: rgba(202, 255, 66, 0.4);
            --level-bubble-core: rgba(202, 255, 66, 0.9);
            
            --font-header: 4rem;      
            --font-clock: 4rem;
            --font-date: 2rem;        
        }

        /* ROTATION BEIBEHALTEN */
        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-variant-numeric: tabular-nums;
            overflow: hidden;
            width: 2560px; height: 1440px;
            transform: rotate(90deg); transform-origin: top left;
            position: absolute; top: 0; left: 1440px; display: flex; flex-direction: column;
        }

        .header {
            padding: 60px 100px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0;
        }
        .header h2 { font-size: var(--font-header); margin: 0; letter-spacing: 2px; font-weight: 700; }
        .time-container { text-align: right; }
        #clock { font-size: var(--font-clock); font-weight: 300; line-height: 1; }
        #date { font-size: var(--font-date); opacity: 0.4; text-transform: uppercase; margin-top: 8px; }

        .view-container { 
            flex-grow: 1; position: relative; padding: 60px 100px; 
            overflow: hidden; display: flex; flex-direction: column;
        }
        
        .view { display: none; width: 100%; height: 100%; animation: fadeIn 0.2s ease-out; }
        .view.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 50px; height: 100%; }

        .card {
            background: var(--card-bg); border-radius: 50px; padding: 40px; 
            border: 4px solid var(--accent-color); display: flex; flex-direction: column; 
            transition: all 0.2s ease; cursor: pointer; text-align: center; position: relative;
        }
        .card:active { transform: scale(0.98); background: rgba(40,40,40,0.95); }
        .card.warning-border { border-color: var(--warning-color) !important; box-shadow: 0 0 30px rgba(255, 204, 0, 0.2); }
        
        .card-layout { height: 100%; width: 100%; display: grid; grid-template-rows: 1fr auto 1fr; align-items: center; justify-items: center; }
        .icon-box { height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; margin: 0; }
        .card-label { font-size: 2.2rem; opacity: 0.5; text-transform: uppercase; letter-spacing: 4px; margin: 0; height: auto; line-height: 1; }
        .val-home { font-size: 7rem; font-weight: 800; line-height: 1; }
        
        .unit { font-size: 3rem; opacity: 0.3; margin-left: 8px; font-weight: 400; display: inline-block; }
        .unit-large { font-size: 1em; opacity: 1; margin-left: 5px; font-weight: 700; }
        .small-label { font-size: 1.5rem; opacity: 0.5; margin-top: 5px; }

        /* ECOFLOW & SWITCHES */
        .eco-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 40px; align-items: center; flex-grow: 1; margin-bottom: 20px; }
        .eco-circle-container { position: relative; width: 420px; height: 420px; margin: 0 auto; border-radius: 50%; border: 15px solid rgba(68, 255, 68, 0.25); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.5s ease; }
        .eco-circle-container.low-soc { border-color: rgba(255, 153, 0, 0.4); }
        .eco-circle-value { font-size: 10rem; font-weight: 900; line-height: 1; }
        .eco-circle-label { font-size: 2rem; opacity: 0.6; margin-top: 10px; }
        .eco-data-box { text-align: center; padding: 40px; background: rgba(255,255,255,0.05); border-radius: 40px; border: 3px solid rgba(255,255,255,0.15); display: flex; flex-direction: column; justify-content: center; }

        .switch-container { display: flex; gap: 120px; justify-content: center; width: 100%; margin-bottom: 80px; }
        .switch-btn { width: 480px; height: 240px; border-radius: 60px; font-size: 2.5rem; font-weight: 800; cursor: pointer; background: rgba(255,255,255,0.05); border: 4px solid var(--accent-color); color: #aaa; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .switch-btn svg { width: 80px !important; height: 80px !important; }
        .switch-btn.active-ac { background: var(--success-color); color: #000; border-color: var(--success-color); box-shadow: 0 0 40px rgba(68, 255, 68, 0.3); }
        .switch-btn.active-dc { background: var(--accent-color); color: #000; border-color: var(--accent-color); box-shadow: 0 0 40px rgba(0, 212, 255, 0.3); }
        .switch-btn.active-usb { background: var(--usb-color); color: #000; border-color: var(--usb-color); box-shadow: 0 0 40px rgba(255, 153, 0, 0.3); }

        .ecoflow-btn { width: 240px; height: 240px; border: 4px solid var(--accent-color); background: rgba(0, 212, 255, 0.05); color: var(--accent-color); border-radius: 60px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; margin-bottom: 10px; }
        .ecoflow-btn:active { transform: scale(0.95); }
        .ecoflow-btn-text { font-weight: 900; font-size: 2.2rem; letter-spacing: 3px; text-transform: uppercase; }
        .ecoflow-btn.offline { border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.4); background: transparent; }

        .split-btn { flex: 1; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: background 0.2s; cursor: pointer; }
        .split-btn:active { background: rgba(255,255,255,0.05); }
        .split-btn-icon { width: 80px !important; height: 80px !important; margin-bottom: 10px; }
        .split-btn-label { font-size: 2rem; font-weight: 700; letter-spacing: 2px; }

        .home-btn { position: fixed; bottom: 80px; right: 80px; width: 240px; height: 240px; background: var(--card-bg); border: 5px solid var(--accent-color); border-radius: 60px; display: none; justify-content: center; align-items: center; cursor: pointer; z-index: 1000; opacity: 0.7; }
        .home-btn svg { width: 192px !important; height: 192px !important; stroke-width: 1.2; color: #ffffff !important; }
        
        .back-btn { position: absolute; top: 40px; right: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 2px solid var(--accent-color); border-radius: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .back-btn svg { width: 60px !important; height: 60px !important; color: var(--accent-color); }
        
        .chart-back-btn { position: fixed; top: 220px; right: 100px; width: 240px; height: 240px; background: var(--card-bg); border: 5px solid var(--accent-color); border-radius: 60px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 1000; opacity: 0.8; }
        .chart-back-btn svg { width: 192px !important; height: 192px !important; color: #ffffff; }

        .info-btn { position: fixed; bottom: 80px; right: 80px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); border-radius: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 900; transition: all 0.2s; }
        .info-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .info-btn svg { width: 60px !important; height: 60px !important; opacity: 0.6; }

        .status-bar { padding: 15px 100px; font-size: 1.5rem; opacity: 0.4; display: flex; justify-content: space-between; border-top: 1px solid rgba(255, 255, 255, 0.05); }
        .large-icon { width: 180px !important; height: 180px !important; }
        .detail-card svg.mid-icon { width: 70px !important; height: 70px !important; margin-bottom: 15px; opacity: 0.7; }
        .status-dot { width: 20px; height: 20px; background: var(--success-color); border-radius: 50%; display: inline-block; margin-right: 20px; }
        .val-mid { font-size: 5.5rem; font-weight: 700; line-height: 1.2; }

        .solar-grid { display: grid; grid-template-columns: 1fr auto; align-items: baseline; gap: 10px; width: 100%; }
        .solar-val { text-align: right; }
        .solar-unit { text-align: left; min-width: 80px; } 

        .subview-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr; grid-template-rows: repeat(2, 1fr); gap: 40px; height: 100%; }
        .klima-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 40px; height: 100%; }
        .detail-card { background: rgba(20, 20, 20, 0.8); border-radius: 40px; padding: 50px; border: 1px solid rgba(255, 255, 255, 0.05); display: flex; flex-direction: column; justify-content: space-between; }
        .border-connected { border: 3px solid rgba(68, 255, 68, 0.4) !important; box-shadow: 0 0 20px rgba(68, 255, 68, 0.05); }
        .border-disconnected { border: 3px solid rgba(255, 204, 0, 0.5) !important; box-shadow: 0 0 20px rgba(255, 204, 0, 0.05); }
        .xtramp-box { border: 4px solid var(--accent-color); box-shadow: 0 0 40px rgba(0, 212, 255, 0.2); background: linear-gradient(145deg, rgba(0, 212, 255, 0.05), rgba(0, 0, 0, 0)); }

        .chart-container { flex: 1; min-height: 0; width: 100%; background: #444444; border-radius: 50px; padding: 30px; padding-bottom: 40px; border: 2px solid rgba(255,255,255,0.1); margin-top: 20px; margin-bottom: 80px; position: relative; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card-bg); border: 4px solid var(--accent-color); padding: 80px; border-radius: 60px; text-align: center; width: 70%; max-width: 1400px; box-shadow: 0 0 100px rgba(0, 212, 255, 0.3); }
        .modal-content h3 { font-size: 5rem; margin: 0 0 40px 0; font-weight: 900; }
        .modal-content p { font-size: 3rem; opacity: 0.8; margin-bottom: 80px; line-height: 1.4; }
        .modal-buttons { display: flex; justify-content: center; gap: 60px; flex-direction: row-reverse; }
        .btn-modal { font-size: 3rem; padding: 40px 100px; border-radius: 40px; cursor: pointer; border: none; font-weight: 700; transition: transform 0.1s; }
        .btn-default { background: var(--accent-color); color: #000; box-shadow: 0 0 30px rgba(0, 212, 255, 0.4); }
        .btn-action { background: rgba(255,255,255,0.1); color: #fff; border: 2px solid rgba(255,255,255,0.2); }
        .btn-modal:active { transform: scale(0.95); }
        .btn-danger { background: var(--danger-color); color: #fff; box-shadow: 0 0 30px rgba(255, 68, 68, 0.4); border: none; }
        #press-trend-icon { width: 50px; height: 50px; vertical-align: middle; margin-left: 10px; color: var(--accent-color); }

        /* INFO VIEW */
        .info-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
        .info-title { font-size: 6rem; font-weight: 900; margin-bottom: 20px; letter-spacing: 3px; }
        .info-subtitle { font-size: 2.5rem; opacity: 0.5; margin-bottom: 80px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; width: 80%; }
        .info-box { padding: 50px; border-radius: 40px; text-align: left; background: rgba(30,30,30,0.8); border: 1px solid rgba(255,255,255,0.1); }
        .info-box h4 { font-size: 2rem; opacity: 0.6; margin: 0 0 20px 0; text-transform: uppercase; }
        .info-box div { font-size: 3rem; font-weight: 700; }
        
        /* NEU: Split-Box Style für Info */
        .info-split-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .info-split-item { display: flex; flex-direction: column; }
        .info-split-label { font-size: 1.5rem; color: #aaa; text-transform: uppercase; margin-bottom: 5px; }
        .info-split-val { font-family: monospace; }
        .wifi-ok { color: var(--accent-color); }
        .wifi-no { color: #555; }

        /* NIVELIERUNG VIEW */
        .level-grid { display: grid; grid-template-rows: 1fr 1fr; gap: 40px; height: 85%; }
        .level-bar-container { background: rgba(30, 30, 30, 1); border-radius: 40px; padding: 40px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px solid rgba(255,255,255,0.1); position: relative; }
        .level-label { position: absolute; top: 40px; left: 60px; font-size: 2.5rem; font-weight: 700; opacity: 0.6; text-transform: uppercase; }
        .level-value-display { position: absolute; top: 40px; right: 60px; font-size: 3rem; font-weight: 700; color: var(--accent-color); }
        .spirit-level { width: 80%; height: 140px; background: var(--level-liquid); border-radius: 70px; position: relative; overflow: hidden; box-shadow: inset 0 5px 20px rgba(0,0,0,0.5); border: 4px solid var(--level-border); }
        .spirit-center-marker { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: rgba(255,255,255,0.3); transform: translateX(-50%); z-index: 10; }
        .spirit-center-zone { position: absolute; left: 50%; top: 0; bottom: 0; width: 140px; background: transparent; transform: translateX(-50%); border-left: 3px solid rgba(255,255,255,0.3); border-right: 3px solid rgba(255,255,255,0.3); z-index: 5; }
        .bubble { width: 160px; height: 90px; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), var(--level-bubble-core)); border-radius: 50px; position: absolute; top: 50%; left: 50%; margin-top: -45px; transform: translateX(-50%); transition: transform 0.2s ease-out; box-shadow: 0 4px 15px rgba(0,0,0,0.4), inset 0 -5px 10px rgba(0,0,0,0.1); border: 2px solid rgba(255,255,255,0.5); z-index: 8; }
        .level-cal-btn { position: absolute; bottom: 80px; left: 100px; padding: 30px 60px; font-size: 2rem; border-radius: 30px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h2>MULTIVAN<span style="color: var(--accent-color); font-weight: 900;">PI</span></h2>
            <p><span id="sys-status-dot" class="status-dot"></span> <span id="sys-status-text">Warte auf Server...</span></p>
        </div>
        <div class="time-container">
            <div id="clock">00:00</div>
            <div id="date">--</div>
        </div>
    </div>

    <div class="view-container">
        <section id="view-home" class="view active">
            <div class="grid">
                <div class="card" id="card-energy" onclick="showView('victron')">
                    <div class="card-layout">
                        <div class="icon-box"><i data-lucide="zap" class="large-icon" color="#00d4ff"></i></div>
                        <div class="card-label">Energie</div>
                        <div id="home-soc" class="val-home">--<span class="unit">%</span></div>
                    </div>
                </div>
                
                <div class="card" onclick="showView('klima')">
                    <div class="card-layout">
                        <div class="icon-box"><i data-lucide="thermometer" class="large-icon"></i></div>
                        <div class="card-label">Klima</div>
                        <div id="home-temp" class="val-home">--<span class="unit">°C</span></div>
                    </div>
                </div>
                
                <div class="card" onclick="showView('level')">
                    <div class="card-layout">
                        <div class="icon-box">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="large-icon">
                               <rect x="1" y="8" width="22" height="8" rx="4" />
                              <line x1="7" y1="8" x2="7" y2="16" />
                              <line x1="17" y1="8" x2="17" y2="16" />
                                  <circle cx="12" cy="12" r="2" />
                            </svg>
                        </div>
                        <div class="card-label">Ausrichten</div>
                        <div style="width: 100%; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px;">
                            <div id="btn-ecoflow-home" class="ecoflow-btn offline" onclick="event.stopPropagation(); showView('ecoflow')">
                                <i data-lucide="package" style="width: 80px; height: 80px;"></i>
                                <div class="ecoflow-btn-text">ECOFLOW</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="padding: 0; overflow: hidden; border: 4px solid var(--accent-color);">
                    <div style="display: flex; flex-direction: column; height: 100%; width: 100%;">
                        <div class="split-btn" onclick="openShutdownModal()">
                            <i data-lucide="power" class="split-btn-icon" style="opacity: 0.3; color: white;"></i>
                            <div class="split-btn-label" style="opacity: 0.5; color: white;">AUSSCHALTEN</div>
                        </div>
                        <div style="display: flex; justify-content: center; align-items: center; padding: 5px 0;">
                             <div class="card-label" style="margin: 0;">System</div>
                        </div>
                        <div class="split-btn" onclick="location.reload()">
                            <i data-lucide="refresh-cw" class="split-btn-icon" style="color: var(--accent-color);"></i>
                            <div class="split-btn-label" style="color: var(--accent-color);">REFRESH</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="info-btn" onclick="showView('info')"><i data-lucide="info"></i></div>
        </section>

        <section id="view-klima" class="view">
            <div class="klima-grid">
                <div class="detail-card">
                    <div><i data-lucide="thermometer-sun" class="mid-icon"></i><div class="card-label">Außen</div></div>
                    <div id="clim-out" class="val-mid">--<span class="unit">°C</span></div>
                </div>
                <div class="detail-card">
                    <div><i data-lucide="home" class="mid-icon"></i><div class="card-label">Innen</div></div>
                    <div id="clim-in" class="val-mid">--<span class="unit">°C</span></div>
                </div>
                <div class="detail-card">
                    <div><i data-lucide="droplets" class="mid-icon"></i><div class="card-label">Feuchte</div></div>
                    <div id="clim-hum" class="val-mid">--<span class="unit">%</span></div>
                </div>
                <div class="detail-card xtramp-box" onclick="showView('press-history')" style="cursor: pointer;">
                    <div><i data-lucide="gauge" class="mid-icon" color="#00d4ff"></i><div class="card-label">Druck</div></div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div class="val-mid"><span id="val-pressure">--</span><span class="unit">hPa</span></div>
                        <i id="press-trend-icon" data-lucide="minus"></i>
                    </div>
                    <div class="small-label" style="color: var(--accent-color);">KLICKEN FÜR DIAGRAMM</div>
                </div>
                <div class="detail-card">
                    <div><i data-lucide="snowflake" class="mid-icon"></i><div class="card-label">Kühlbox</div></div>
                    <div id="clim-fridge" class="val-mid">--<span class="unit">°C</span></div>
                </div>
                <div class="detail-card">
                    <div><i data-lucide="thermometer-snowflake" class="mid-icon"></i><div class="card-label">LiFePO4</div></div>
                    <div id="clim-batt" class="val-mid">--<span class="unit">°C</span></div>
                </div>
            </div>
        </section>
        
        <section id="view-press-history" class="view">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div><h1 style="font-size: 5rem; margin: 0; color: var(--accent-color);">Luftdruck-Verlauf</h1><p style="font-size: 2rem; opacity: 0.5;">Letzte 3 Tage (10 min)</p></div>
            </div>
            <div class="chart-container"><canvas id="large-press-chart"></canvas></div>
            <div class="chart-back-btn" onclick="showView('klima')"><i data-lucide="arrow-left"></i></div>
        </section>

        <section id="view-ecoflow" class="view">
            <div class="eco-grid">
                <div class="eco-data-box">
                    <i data-lucide="plug-zap" class="large-icon" style="color: #ffcc00; margin-bottom: 20px;"></i>
                    <div class="card-label">Eingang</div>
                    <div id="eco-view-in" class="val-mid">0<span class="unit">W</span></div>
                    <div class="small-label">Solar / AC</div>
                </div>
                <div id="eco-circle" class="eco-circle-container">
                    <div id="eco-view-soc" class="eco-circle-value">--<span style="font-size: 4rem;">%</span></div>
                    <div id="eco-view-remain" class="eco-circle-label">-- Std verbleibend</div>
                </div>
                <div class="eco-data-box">
                    <i data-lucide="power" class="large-icon" style="color: var(--accent-color); margin-bottom: 20px;"></i>
                    <div class="card-label">Ausgang</div>
                    <div id="eco-view-out" class="val-mid">0<span class="unit">W</span></div>
                    <div class="small-label">AC / DC / USB</div>
                </div>
            </div>
            <div class="switch-container">
                <div id="sw-ac" class="switch-btn" onclick="toggleEcoFlow('ac')"><i data-lucide="plug"></i><div>AC 230V</div></div>
                <div id="sw-dc" class="switch-btn" onclick="toggleEcoFlow('dc')"><i data-lucide="zap"></i><div>12V KFZ</div></div>
                <div id="sw-usb" class="switch-btn" onclick="toggleEcoFlow('usb')"><i data-lucide="smartphone"></i><div>USB</div></div>
            </div>
        </section>

        <section id="view-info" class="view">
            <div class="info-container">
                <div class="info-title">MULTIVAN<span style="color: var(--accent-color);">PI</span> <span id="info-version-display" style="font-size: 3rem; opacity: 0.5;">v--</span></div>
                <div class="info-subtitle">&copy; 2024-2026 Fred Fiedler, alle Rechte vorbehalten.</div>
                
                <div class="info-grid">
                    <div class="info-box xtramp-box">
                        <h4>Hardware</h4>
                        <div>Raspberry Pi 4B</div>
                        <div style="font-size: 2rem; opacity: 0.7; margin-top: 10px;">4GB RAM</div>
                        <div style="font-size: 1.5rem; color: var(--accent-color); margin-top: 20px; font-weight: 700;">EcoFlow Delta 3+<br><span style="opacity: 0.6; font-size: 1.2rem;">(Portable Integration)</span></div>
                    </div>
                    <div class="info-box">
                        <h4>System Status</h4>
                        <div style="display: flex; justify-content: space-between;">
                            <span>CPU Temp:</span><span style="color: var(--accent-color);"><span id="info-cpu">--</span>°C</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <span>RTC Temp:</span><span style="color: var(--accent-color);"><span id="info-rtc">--</span>°C</span>
                        </div>
                    </div>
                    <div class="info-box">
                        <h4>Software</h4>
                        <div style="font-size: 2rem;">Python <span id="info-python">--</span></div>
                    </div>
                    
                    <div class="info-box">
                        <div class="info-split-row">
                            <div class="info-split-item">
                                <div class="info-split-label">Session ID</div>
                                <div class="info-split-val" id="info-session" style="font-size: 2.2rem;">--</div>
                            </div>
                            <div class="info-split-item" style="text-align: right;">
                                <div class="info-split-label">WLAN</div>
                                <div class="info-split-val" id="info-wifi" style="font-size: 2.2rem;">...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-victron" class="view">
            <div class="subview-grid">
                <div class="detail-card" id="card-vic-shunt" style="grid-row: span 2;">
                    <div><div class="card-label">SmartShunt Aufbau</div><div id="vic-soc" style="font-size: 14rem; font-weight: 900; color: var(--accent-color);">--<span class="unit" style="font-size: 6rem;">%</span></div></div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div><div class="small-label">Spannung</div><div id="vic-volt-aufbau" class="val-mid">--<span class="unit">V</span></div></div>
                        <div><div class="small-label">Strom</div><div id="vic-amp-aufbau" class="val-mid">--<span class="unit">A</span></div></div>
                    </div>
                    <div id="vic-shunt-status" class="small-label" style="opacity:0.6; margin-top:20px;">Warte auf BLE...</div>
                </div>
                <div class="detail-card" id="card-vic-solar" style="flex-direction: row;">
                    <div style="display: flex; flex-direction: column; justify-content: space-between; height: 100%; flex-shrink: 0;">
                        <div><i data-lucide="sun" class="mid-icon" color="#ffcc00"></i><div class="card-label">Solar</div></div>
                        <div id="vic-solar-status" class="small-label">Warte auf BLE...</div>
                    </div>
                    <div style="display: flex; flex-direction: column; justify-content: center; width: 100%; align-items: flex-end;">
                        <div class="solar-grid">
                            <div id="val-solar-watt" class="val-mid solar-val">--</div><div class="val-mid solar-unit"><span class="unit-large">W</span></div>
                            <div id="val-solar-amp" class="val-mid solar-val">--</div><div class="val-mid solar-unit"><span class="unit-large">A</span></div>
                        </div>
                        <div class="small-label" style="font-size: 1.2rem; opacity: 0.5; margin-right: 15px; margin-top: 10px;">Lastausgang</div>
                    </div>
                </div>
                <div class="detail-card" id="card-vic-booster">
                    <div><i data-lucide="truck" class="mid-icon"></i><div class="card-label">Booster</div></div>
                    <div id="vic-booster" class="val-mid">--<span class="unit">A</span></div>
                    <div id="vic-booster-status" class="small-label">Warte auf BLE...</div>
                </div>
                <div class="detail-card" id="card-vic-sense">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mid-icon">
                          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><line x1="16" y1="3" x2="16" y2="7"></line><line x1="8" y1="3" x2="8" y2="7"></line><line x1="5" y1="14" x2="9" y2="14"></line> <line x1="15" y1="14" x2="19" y2="14"></line> <line x1="17" y1="12" x2="17" y2="16"></line> </svg>
                        <div class="card-label">SmartSense</div>
                    </div>
                    <div id="vic-sense" class="val-mid">--<span class="unit-large">V</span></div>
                    <div id="vic-sense-status" class="small-label">Warte auf BLE...</div>
                </div>
                <div class="detail-card" id="card-vic-starter">
                    <div><i data-lucide="battery" class="mid-icon"></i><div class="card-label">Starter</div></div>
                    <div id="vic-starter" class="val-mid">--<span class="unit">V</span></div>
                    <div id="vic-starter-status" class="small-label">Warte auf BLE...</div>
                </div>
            </div>
        </section>

        <section id="view-level" class="view">
            <div class="level-grid">
                <div class="level-bar-container">
                    <div class="level-label"><i data-lucide="arrow-left-right" style="margin-right:20px;"></i>Quer (Roll)</div>
                    <div class="level-value-display" id="disp-roll">0°</div>
                    <div class="spirit-level"><div class="spirit-center-marker"></div><div class="spirit-center-zone"></div><div id="bubble-roll" class="bubble"></div></div>
                    <div id="cm-roll" style="margin-top:20px; font-size:3rem; font-weight:700; color:var(--accent-color);">0 cm Korrektur</div>
                </div>
                <div class="level-bar-container">
                    <div class="level-label"><i data-lucide="arrow-up-down" style="margin-right:20px;"></i>Längs (Pitch)</div>
                    <div class="level-value-display" id="disp-pitch">0°</div>
                    <div class="spirit-level"><div class="spirit-center-marker"></div><div class="spirit-center-zone"></div><div id="bubble-pitch" class="bubble"></div></div>
                    <div id="cm-pitch" style="margin-top:20px; font-size:3rem; font-weight:700; color:var(--accent-color);">0 cm Korrektur</div>
                </div>
            </div>
            <button class="level-cal-btn" onclick="openCalModal()"><i data-lucide="crosshair" style="width:30px; height:30px; vertical-align:middle; margin-right:15px;"></i>Kalibrieren</button>
        </section>
    </div>

    <div class="status-bar"><div id="sys-id">Server-ID: Suche...</div><div id="sys-pkts">Empfangene Pakete: 0</div></div>
    <div id="btn-home" class="home-btn" onclick="showView('home')"><i data-lucide="home"></i></div>

    <div id="cal-modal" class="modal">
        <div class="modal-content">
            <h3>Kalibrierung</h3><p>Steht das Fahrzeug gerade?<br>Diese Position wird als 0° gespeichert.</p>
            <div class="modal-buttons"><button class="btn-modal btn-default" onclick="closeCalModal()" autofocus>Abbrechen</button><button id="btn-cal-save" class="btn-modal btn-action" onclick="confirmCalibration()">Speichern</button></div>
        </div>
    </div>
    <div id="shutdown-modal" class="modal">
        <div class="modal-content" style="border-color: var(--accent-color); box-shadow: 0 0 100px rgba(0, 212, 255, 0.3);">
            <h3 style="color: var(--accent-color);">System beenden</h3><p>Möchtest du den Raspberry Pi wirklich<br>herunterfahren?</p>
            <div class="modal-buttons"><button class="btn-modal btn-action" onclick="closeShutdownModal()">Abbrechen</button><button id="btn-shutdown-confirm" class="btn-modal btn-danger" onclick="confirmShutdown()">Herunterfahren</button></div>
        </div>
    </div>

    <script>
        let pressureChart = null;
        function safeIconLoad() { if (typeof lucide !== 'undefined' && window.lucide) { window.lucide.createIcons(); } else { setTimeout(safeIconLoad, 100); } }
        function refreshIcons() { if (typeof lucide !== 'undefined' && window.lucide) { window.lucide.createIcons(); } }
        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            document.getElementById('btn-home').style.display = (id === 'home') ? 'none' : 'flex';
            refreshIcons();
            if(id === 'press-history') initLargeChart();
        }

        let ecoflowState = { ac: false, dc: false, usb: false };
        async function toggleEcoFlow(type) {
            const newState = !ecoflowState[type];
            updateSwitchUI(type, newState);
            try { await fetch("http://127.0.0.1:3000/api/ecoflow/switch", { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: type, state: newState }) });
            } catch(e) { console.error("Switch failed", e); updateSwitchUI(type, !newState); }
        }
        function updateSwitchUI(type, isOn) {
            const btn = document.getElementById('sw-' + type); if(!btn) return;
            if(isOn) btn.classList.add('active-' + type); else btn.classList.remove('active-' + type);
        }

        function openCalModal() { document.getElementById('cal-modal').style.display = 'flex'; }
        function closeCalModal() { document.getElementById('cal-modal').style.display = 'none'; }
        async function confirmCalibration() {
            const btn = document.getElementById('btn-cal-save'); btn.innerHTML = "SPEICHERE...";
            try { await fetch("http://127.0.0.1:3000/api/level/calibrate", { method: 'POST' });
                btn.innerHTML = "GESPEICHERT!"; btn.style.background = "var(--success-color)"; btn.style.color = "#000"; btn.style.borderColor = "var(--success-color)";
                setTimeout(() => { closeCalModal(); setTimeout(() => { btn.innerHTML = "Speichern"; btn.style.background = ""; btn.style.color = ""; btn.style.borderColor = ""; }, 500); }, 1000);
            } catch(e) { btn.innerHTML = "FEHLER!"; btn.style.background = "var(--danger-color)"; setTimeout(() => { btn.innerHTML = "Speichern"; btn.style.background = ""; btn.style.borderColor = ""; }, 2000); }
        }

        function openShutdownModal() { document.getElementById('shutdown-modal').style.display = 'flex'; }
        function closeShutdownModal() { document.getElementById('shutdown-modal').style.display = 'none'; }
        async function confirmShutdown() {
            const btn = document.getElementById('btn-shutdown-confirm'); btn.innerHTML = "FAHRE HERUNTER...";
            document.body.style.opacity = "0.3"; document.body.style.pointerEvents = "none";
            fetch("http://127.0.0.1:3000/api/shutdown", { method: 'POST' }).catch(e => console.log("Shutdown request sent"));
        }        
        function updateCardStatus(cardId, lastSeenStr) {
            const card = document.getElementById(cardId); if (!card) return;
            if (lastSeenStr && lastSeenStr !== "Suche...") { card.classList.remove('border-disconnected'); card.classList.add('border-connected');
            } else { card.classList.remove('border-connected'); card.classList.add('border-disconnected'); }
        }
        function getSeconds(timeStr) {
            if (!timeStr || timeStr === "Suche...") return null;
            const parts = timeStr.split(':'); return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        }

        async function fetchData() {
            try {
                const res = await fetch("http://127.0.0.1:3000/api/data?t=" + Date.now());
                if (!res.ok) throw new Error();
                const data = await res.json();

                document.getElementById('sys-id').innerText = "Server-ID: " + (data.session || "Verbunden");
                document.getElementById('sys-pkts').innerText = "Empfangene Pakete: " + (data.sense_packets || 0);

                if (data.level_roll !== undefined) updateLevelUI(data.level_roll, data.level_pitch);
                
                const nowSec = getSeconds(data.server_time);
                const energyCard = document.getElementById('card-energy');
                if (data.aufbau_soc !== undefined) {
                    document.getElementById('home-soc').innerHTML = data.aufbau_soc.toFixed(1) + '<span class="unit">%</span>';
                    let isOffline = true;
                    if (data.shunt_aufbau_last !== "Suche..." && nowSec !== null) {
                        const lastSec = getSeconds(data.shunt_aufbau_last);
                        if (lastSec !== null) { let diff = nowSec - lastSec; if (diff < 0) diff += 86400; if (diff <= 120) isOffline = false; }
                    }
                    if (isOffline) { energyCard.classList.add('warning-border'); document.getElementById('vic-shunt-status').innerText = data.shunt_aufbau_last !== "Suche..." ? "Status: VERBINDUNG VERLOREN (" + data.shunt_aufbau_last + ")" : "Status: Warte auf BLE...";
                    } else { energyCard.classList.remove('warning-border'); document.getElementById('vic-shunt-status').innerText = "Status: LIVE (" + data.shunt_aufbau_last + ")"; }
                }
                
                if (data.temp_in !== undefined) document.getElementById('home-temp').innerHTML = data.temp_in.toFixed(1) + '<span class="unit">°C</span>';

                // VICTRON
                if (data.aufbau_soc !== undefined) document.getElementById('vic-soc').innerHTML = data.aufbau_soc.toFixed(1) + '<span class="unit" style="font-size: 6rem;">%</span>';
                if (data.aufbau_volt !== undefined) document.getElementById('vic-volt-aufbau').innerText = data.aufbau_volt.toFixed(2) + "V";
                if (data.aufbau_amp !== undefined) document.getElementById('vic-amp-aufbau').innerText = data.aufbau_amp.toFixed(1) + "A";
                
                updateCardStatus('card-vic-shunt', data.shunt_aufbau_last); updateCardStatus('card-vic-solar', data.solar_last);
                updateCardStatus('card-vic-booster', data.booster_last); updateCardStatus('card-vic-sense', data.sense_last); updateCardStatus('card-vic-starter', data.shunt_starter_last);
                
                if (data.ecoflow_soc !== undefined) {
                    document.getElementById('eco-view-soc').innerHTML = data.ecoflow_soc.toFixed(1) + '<span style="font-size: 4rem;">%</span>';
                    document.getElementById('eco-view-in').innerHTML = data.ecoflow_in + '<span class="unit">W</span>';
                    document.getElementById('eco-view-out').innerHTML = data.ecoflow_out + '<span class="unit">W</span>';
                    const mins = data.ecoflow_remain;
                    if (mins > 1440) document.getElementById('eco-view-remain').innerText = "> 24 Std";
                    else if (mins > 60) document.getElementById('eco-view-remain').innerText = Math.floor(mins/60) + " Std " + Math.floor(mins%60) + " Min";
                    else document.getElementById('eco-view-remain').innerText = Math.floor(mins) + " Min";
                    const ecoCircle = document.getElementById('eco-circle');
                    if(ecoCircle) { if(data.ecoflow_soc > 20) ecoCircle.classList.remove('low-soc'); else ecoCircle.classList.add('low-soc'); }
                    ecoflowState.ac = data.ecoflow_ac_on; ecoflowState.dc = data.ecoflow_dc_on; ecoflowState.usb = data.ecoflow_usb_on;
                    updateSwitchUI('ac', ecoflowState.ac); updateSwitchUI('dc', ecoflowState.dc); updateSwitchUI('usb', ecoflowState.usb);
                    const ecoHomeBtn = document.getElementById('btn-ecoflow-home');
                    if (data.ecoflow_connected) ecoHomeBtn.classList.remove('offline'); else ecoHomeBtn.classList.add('offline');
                }

                if (data.sense_volt !== undefined) { document.getElementById('vic-sense').innerHTML = data.sense_volt.toFixed(2) + '<span class="unit-large">V</span>'; document.getElementById('vic-sense-status').innerText = "Status: " + (data.sense_packets > 0 ? "LIVE (" + data.sense_last + ")" : "Warte auf BLE..."); }
                if (data.sense_temp !== undefined) { document.getElementById('clim-batt').innerHTML = parseFloat(data.sense_temp).toFixed(1) + '<span class="unit">°C</span>'; }
                if (data.solar_watt !== undefined) { document.getElementById('val-solar-watt').innerText = data.solar_watt.toFixed(1); document.getElementById('val-solar-amp').innerText = (data.mppt_load_amp || 0.0).toFixed(1); document.getElementById('vic-solar-status').innerText = "Status: " + (data.solar_last !== "Suche..." ? "LIVE (" + data.solar_last + ")" : "Warte auf BLE..."); }
                if (data.starter_volt !== undefined) { document.getElementById('vic-starter').innerText = data.starter_volt.toFixed(2) + "V"; document.getElementById('vic-starter-status').innerText = "Status: " + (data.shunt_starter_last !== "Suche..." ? "LIVE (" + data.shunt_starter_last + ")" : "Warte auf BLE..."); }
                if (data.booster_amp !== undefined) { document.getElementById('vic-booster').innerText = data.booster_amp.toFixed(1) + "A"; document.getElementById('vic-booster-status').innerText = "Status: " + (data.booster_last !== "Suche..." ? "LIVE (" + data.booster_last + ")" : "Warte auf BLE..."); }

                if (data.temp_out !== undefined) document.getElementById('clim-out').innerHTML = data.temp_out.toFixed(1) + '<span class="unit">°C</span>';
                if (data.temp_in !== undefined) document.getElementById('clim-in').innerHTML = data.temp_in.toFixed(1) + '<span class="unit">°C</span>';
                if (data.humidity !== undefined) document.getElementById('clim-hum').innerHTML = data.humidity.toFixed(1) + '<span class="unit">%</span>';
                if (data.pressure !== undefined) { document.getElementById('val-pressure').innerText = data.pressure.toFixed(0); updatePressureTrend(data.pressure_trend); }
                
                if (data.temp_fridge !== undefined) document.getElementById('clim-fridge').innerHTML = data.temp_fridge.toFixed(1) + '<span class="unit">°C</span>';
                if (data.pressure_history && document.getElementById('view-press-history').classList.contains('active')) { updateLargeChart(data.pressure_history); }

                // SYSTEM & INFO
                if (data.sys_cpu_temp) document.getElementById('info-cpu').innerText = data.sys_cpu_temp;
                if (data.sys_rtc_temp !== undefined) document.getElementById('info-rtc').innerText = data.sys_rtc_temp; 
                if (data.sys_python) document.getElementById('info-python').innerText = data.sys_python;
                if (data.session) document.getElementById('info-session').innerText = data.session;
                
                // WLAN UPDATE (HIER NEU)
                if (data.sys_ssid) {
                    document.getElementById('info-wifi').innerText = data.sys_ssid;
                    document.getElementById('info-wifi').className = "info-split-val wifi-ok";
                } else {
                    document.getElementById('info-wifi').innerText = "Getrennt";
                    document.getElementById('info-wifi').className = "info-split-val wifi-no";
                }

                if (data.sys_backend_version) document.getElementById('info-version-display').innerText = "V" + FRONT_VERSION + " - " + data.sys_backend_version;

                document.getElementById('sys-status-dot').style.backgroundColor = "var(--success-color)";
                document.getElementById('sys-status-text').innerText = "SYSTEM ONLINE";
            } catch (e) {
                document.getElementById('sys-status-dot').style.backgroundColor = "red";
                document.getElementById('sys-status-text').innerText = "VERBINDUNGSFEHLER";
            }
        }

        function updatePressureTrend(trend) {
            const icon = document.getElementById('press-trend-icon'); if(!icon) return;
            let iconName = "arrow-right";
            if(trend === "steigend") iconName = "arrow-up-right";
            if(trend === "fallend") iconName = "arrow-down-right";
            if(icon.getAttribute('data-lucide') !== iconName) { icon.setAttribute('data-lucide', iconName); refreshIcons(); }
        }

        let largePressChart = null;
        function initLargeChart() {
            if(!window.Chart) return;
            const ctx = document.getElementById('large-press-chart'); if(!ctx || largePressChart) return;
            largePressChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Luftdruck', data: [], borderColor: '#e09f3e', borderWidth: 4, fill: false, tension: 0.4, pointRadius: 0, pointHitRadius: 10, spanGaps: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false, color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.6)', font: { size: 16 }, maxTicksLimit: 8 }, offset: true }, y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.8)', font: { size: 20 } }, grace: '25%' } }, layout: { padding: { left: 10, right: 10, top: 10, bottom: 10 } } }
            });
        }
        function updateLargeChart(history) {
            if (!largePressChart || !history || !history.length) return;
            largePressChart.data.labels = history.map(h => {
                const d = new Date(h.ts * 1000); const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
                return days[d.getDay()] + " " + d.getHours() + "h";
            });
            largePressChart.data.datasets[0].data = history.map(h => (h.val > 800) ? h.val : null);
            largePressChart.update('none');
        }

        function updateLevelUI(roll, pitch) {
            const bRoll = document.getElementById('bubble-roll');
            let rawCmRoll = Math.sin(roll * (Math.PI/180)) * 156;
            let cmRoll = Math.round(rawCmRoll / 3) * 3;
            let moveRoll = (rawCmRoll / 20) * 800; 
            if (moveRoll > 800) moveRoll = 800; if (moveRoll < -800) moveRoll = -800;
            bRoll.style.transform = `translateX(calc(-50% + ${moveRoll}px))`;
            document.getElementById('disp-roll').innerText = Math.abs(roll).toFixed(1) + "°";
            document.getElementById('cm-roll').innerText = (cmRoll > 0 ? "Rechts " : "Links ") + Math.abs(cmRoll).toFixed(0) + " cm unterlegen";
            const bPitch = document.getElementById('bubble-pitch');
            let rawCmPitch = Math.sin(pitch * (Math.PI/180)) * 292;
            let cmPitch = Math.round(rawCmPitch / 3) * 3;
            let movePitch = (rawCmPitch / 20) * 800;
            if (movePitch > 800) movePitch = 800; if (movePitch < -800) movePitch = -800;
            bPitch.style.transform = `translateX(calc(-50% + ${movePitch}px))`;
            document.getElementById('disp-pitch').innerText = Math.abs(pitch).toFixed(1) + "°";
            document.getElementById('cm-pitch').innerText = (cmPitch > 0 ? "Hinten " : "Vorne ") + Math.abs(cmPitch).toFixed(0) + " cm unterlegen";
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('date').textContent = now.toLocaleDateString('de-DE', {weekday: 'long', day: 'numeric', month: 'long'});
        }

        window.onload = safeIconLoad;
        setInterval(updateClock, 1000); 
        setInterval(fetchData, 500);
        updateClock(); fetchData(); 
    </script>
</body>
</html>